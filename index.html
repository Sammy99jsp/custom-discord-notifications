<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
    <link rel="stylesheet" href="main.css">
    <title>Custom Discord Notification Badges</title>
</head>
<body>
    <div class="ui container">
        <br>
        <h2>Custom Discord Notification Badges</h2>
        <br>
        <div class="ui basic segments">
            <div class="ui segment" style="display: none;">
                <em>Preview</em>
                <canvas id="preview-48" width="48" height="48"></canvas>
                <canvas id="preview-32" width="32" height="32"></canvas>
                <canvas id="preview-16" width="16" height="16"></canvas>
            </div>
            <div class="ui segment">
                <h2>How to Customise Discord Badges</h2>
                <div class="ui grid">
                    <div class="column">
                            <img class="ui tiny left floated image" src="guide/badge.png" alt="Discord Badge Example">
                            <div class="meta">
                                <br>
                                <i class="clock icon"></i> ~ 5 Min Guide<br>
                                <i class="windows icon"></i> Windows Computers Only
                            </div>
                        </div>
                </div>
            </div>
            <div class="ui segment">
                <ol>
                    <li>
                        <i class="big check icon" id="step-one" title="Complete form below to complete step"></i>
                        <span> <i class="brush icon"></i> Choose your color scheme. Once you're done, click download to download the icons into a folder of your choice.</span>
                        <br>
                        <div class="preview">
                            <div class="badge">
                                <label>4</label>
                            </div>
                            <div class="desc">Preview</div>
                        </div>
                        <form class="ui form" id="color-picker">
                            <div class="formy-row">
                                <div class="ui two fields">
                                    <div class="ui field">
                                        <div class="ui color input">
                                            <div class="circle"></div>
                                            <label>Background Color</label>
                                            <input type="color" id="background-color"><br>    
                                            <i class="right tint icon"></i>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui color input">
                                            <div class="white circle"></div>
                                            <label>Text Color</label>
                                            <input type="color" id="foreground-color" value="#FFFFFF"><br>    
                                            <i class="right tint icon"></i>
                                        </div>    
                                    </div>
                                </div>
                                <div class="ui field">
                                    <button id="getFolder" type="submit" class="ui primary button"><i class="download icon"></i>&nbsp;Download</button>
                                </div>
                            </div>
                        </form>
                        <p>You'll need to grant us permission to write to that folder.</p>
                        <div id="loading">
                            <br>
                        </div>
                        <br>
                    </li>
                    <li>
                        <i class="big check icon checkable" title="Mark step as complete."></i>
                        Close <i class="discord icon"></i> Discord, if it's open. 
                        <br>
                        <br>
                    </li>
                    <li>
                        <i class="big check icon checkable" title="Mark step as complete."></i>
                        Copy/Paste the icons from the selected folder into the <kbd class="folder copyable">%appdata%\discord</kbd> folder.<br>
                        <div class="ui icon message">
                            <i class="exclamation triangle icon"></i>
                            <div class="content">
                              <div class="header">
                                Backup
                              </div>
                              It is advised to make a backup of the current icons (all the <kbd class="folder">badge.ico</kbd> files) into a new folder such as <kbd class="folder copyable">badge_backup</kbd>.
                            </div>
                        </div>
                        <br>
                    </li>
                    <li>
                        <i class="big check icon checkable" title="Mark step as complete."></i>
                        <span class="title">
                            Reload the <i class="windows icon"></i>&nbsp;Windows Icon Cache
                        </span>
                        <p>In order for your cool new badges to be displayed in the taskbar, we'll need quickly stop Windows Explorer whilst we clear the icon cache in order for our changes to take effect.</p>
                        <br>
                        <span>Run the following commands in an <i class="shield alternate icon"></i>&nbsp;<em>Administrator</em>&nbsp;&nbsp;<i class="terminal icon"></i>&nbsp;<em>Command Prompt/Powershell terminal</em></span>
                        <div class="commands">
                            <div class="line">
                                <span class="non-sel">C:\Windows\System32></span>
                                <span class="copyable">taskkill /IM explorer.exe /F</span>
                            </div>
                            <div class="line">
                                <span class="non-sel">C:\Windows\System32></span>
                                <span class="copyable">cd /d %userprofile%\AppData\Local</span>
                            </div>
                            <div class="line">
                                <span class="non-sel">C:\Users\...\AppData\Local></span>
                                <span class="copyable">del IconCache.db /a</span>
                            </div>
                            <div class="line">
                                <span class="non-sel">C:\Users\...\AppData\Local></span>
                                <span class="copyable">explorer.exe</span>
                            </div>
                        </div>
                        <br>
                    </li>
                    <li>
                        <i class="big check icon checkable" title="Mark step as complete."></i>
                        Restart Discord <i class="discord icon"></i>.
                    </li>
                </ol>
            </div>
        </div>
    </div>
    <div class="ui inverted vertical footer segment form-page">
        <div class="ui container">
          Made by <a href="https://github.com/Sammy99jsp"><i class="icon github"></i>&nbsp;Sammy99jsp</a> with <i class="heart icon"></i> using:
          <ul>
              <li><a href="https://jquery.com/">JQuery</a></li>
              <li><a href="https://fomantic-ui.com/">Fomantic UI</a></li>
              <li><a href="https://github.com/KnicKnic/WASM-ImageMagick/">WASM Imagemagick</a></li>
          </ul>
        </div>
      </div>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>
    <script type="module">
        import * as Magick from 'https://knicknic.github.io/wasm-imagemagick/magickApi.js';
        window.color = {"background-color": "CAB100", "foreground-color": "FFFFFF"};
        const svgSplitter = /(?<=.cls-[0-9]{fill:#)([0-9a-f]+)(?=;})/g
        const SIZES = [48, 32, 16];
        const range = [1, 11]; // Inclusive
        
        let progress = 0;
        
        // From https://stackoverflow.com/questions/985272/selecting-text-in-an-element-akin-to-highlighting-with-your-mouse
        function selectText(node) {
            if (document.body.createTextRange) {
                const range = document.body.createTextRange();
                range.moveToElementText(node);
                range.select();
            } else if (window.getSelection) {
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(node);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                console.warn("Could not select text in node: Unsupported browser.");
            }
        }
        
        $('.checkable').on("click", function(e) {
            e.preventDefault();
            $(this).addClass("green");
        });

        $('.ui.color.input').on('click' , function(e) {
            $(this).find('input[type="color"]').click();
        })

        $('.ui.color.input input[type="color"]').on('click', function(e) {
            e.stopPropagation();
        })

        $('.copyable').on('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            selectText($(this)[0]);
        })

        $('.ui.color.input input[type="color"]').on('change', function(e) {
            // Update Picker UI
            $(this).siblings(".circle").css({"background-color": $(this).val()});

            let type = $(this).attr("id");
            // Update Preview
            $('.preview .badge').css({[type === "background-color" ? "background-color" : "color"]: $(this).val()})
        })

        function updateProgress() {
            if(progress === 0 ){
                $(`
                <div class="ui indicating progress" data-value="0" data-total="${range[1]}" id="progress">
                    <div class="bar">
                        <div class="progress"></div>
                    </div>
                    <div class="label">Icons Made: 0 / 11</div>
                </div>
                `)
                    .appendTo("#loading")
                    .progress({
                        duration : range[1],
                        total    : range[1],
                        text     : {
                            active: 'Icons made: {value} / {total}'
                        }
                    });
                    $('#step-one').removeClass("gray").addClass("green")
            }
            progress++;
            $('#progress').progress('increment');
            if(progress === range[1]) {
                // Finished stuff! Yay! Display some sort of message!
                $('#loading').append(
                `<div class="ui green icon message">
                     <i class="check circle icon"></i>
                     <div class="content">
                         <div class="header">
                         Icons created!
                         </div>
                         <p>Hey! Check your chosen folder to see if they've been made!</p>
                     </div>
                 </div>`);
                $('#step-one').addClass("check");
            }
        }

        document.getElementById('color-picker').addEventListener("submit", async function(e) {
            e.preventDefault();
            window.color = {
                "background-color": document.getElementById('background-color').value.substring(1),
                "foreground-color": document.getElementById('foreground-color').value.substring(1)
            }
            const dirHandle = await window.showDirectoryPicker();
            $(this).toggleClass("loading");
            for (let i = range[0]; i < range[1] + 1; i++) {
                await testStuff(i);
                let data = await stepTwo(i);
                const fileHandle = await dirHandle.getFileHandle(`badge-${i}.ico`, {create: true});
                const writable = await fileHandle.createWritable();
                await writable.write(data);
                await writable.close();
                console.log("Written to", `badge-${i}.ico`, "successfully! Poggers!");
                updateProgress();
            }
            $(this).toggleClass("loading");
        });

        function testStuff(i) {
            return new Promise(async (res, rej) => {
                const canvases = SIZES.map(e => document.getElementById('preview-' + e));
                const contexts = canvases.map(e => e.getContext("2d"));

                let img = new Image();
                img.onload = () => { 
                    contexts.forEach(ctx => ctx.drawImage(img, 0, 0)); 
                    res();
                } 

                let svg = await fetch(`img/badge-${i}.svg`)
                svg = await svg.text();
                svg = svg.split(svgSplitter);
                svg[1] = window.color["background-color"];
                svg[3] = window.color["foreground-color"];
                let filtered = svg.join(""); 
                console.log(filtered);
                const blob = new Blob([filtered], {type: "image/svg+xml"});
                img.src = URL.createObjectURL(blob);
            })
        }


        async function stepTwo(index) {
            const canvases = SIZES.map(e => document.getElementById('preview-' + e));
            let dataSizes = canvases.map(canvas => 
                new Promise((res, rej) => 
                    canvas.toBlob(res, "image/png")
                )
            );

            dataSizes = await Promise.all(dataSizes);
            console.log(dataSizes)
            dataSizes = dataSizes.map(blob => blob.arrayBuffer());
            dataSizes = await Promise.all(dataSizes);
            console.log(dataSizes);
            dataSizes = dataSizes.map((e, i) => ({name: `badge-${index}-${SIZES[i]}.png`, content: new Uint8Array(e)}));
            console.log(dataSizes);

            const files = dataSizes;
            const command = ["convert", ...(dataSizes.map(e => e.name)), `badge-${index}.ico`];
            console.log(command);
            let processedFiles = await Magick.Call(files, command);
            let firstOutputImage = processedFiles[0];
            return firstOutputImage['blob'];
        }
        </script>
    </body>
</html>